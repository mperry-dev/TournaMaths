<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Math Question Builder with Boxed Placeholder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
    <style>
        body {
            display: flex;
        }
        #builder, #question-list {
            flex: 1;
            padding: 10px;
        }
        #question-preview {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            background-color: #f9f9f9;
        }
        #question-list {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            background-color: #f9f9f9;
            overflow-y: auto;
            height: 500px;
        }
        .symbol-button {
            padding: 0.25rem 0.5rem;
            text-align: center;
        }
        .input-field {
            margin-top: 10px;
            width: 100%;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(25px, 1fr));
            gap: 5px;
        }
    </style>
</head>
<body>
    <div id="builder">
        <h1>Math Question Builder</h1>

        <div class="grid">
            <!-- Buttons for maths symbols -->
            <button class="symbol-button" data-symbol="+" title="plus">+</button>
            <button class="symbol-button" data-symbol="-" title="minus">-</button>
            <button class="symbol-button" data-symbol="\times" title="multiply">×</button>
            <button class="symbol-button" data-symbol="\div" title="divide">÷</button>
            <button class="symbol-button" data-symbol="=" title="equals">=</button>
            <button class="symbol-button" data-symbol="\sqrt{}" title="square root">√</button>
            <button class="symbol-button" data-symbol="^{ }" title="power">^</button>
            <!-- Student answer placeholder button -->
            <button class="symbol-button" data-symbol="\boxed{}" title="Box for student to enter answer in">□</button>
        </div>

        <form method="POST" action="/create_questions">
            <h2>Question ID:</h2>
            <input type="text" id="question-id-input" name="identifier" class="input-field" placeholder="Enter a unique ID for the problem" />

            <h2>Description:</h2>
            <input type="text" id="description-input" name="description" class="input-field" placeholder="Enter a description for the problem" />

            <h2>Your Equation:</h2>
            <input type="text" id="equation-input" name="equation" /><br />
            <div id="question-preview"></div>

            <input type="submit" value="Submit"/>
        </form>
    </div>

    <div id="question-list">
        <h2>All Questions:</h2>
        <ul>
            <li th:each="question : ${questions}">
                <strong>ID:</strong> <span th:text="${question.identifier}"></span><br>
                <strong>Description:</strong> <span th:text="${question.description}"></span><br>
                <strong>Equation:</strong> <span th:text="${question.equation}" class="katex-equation"></span><br>
                <hr>
            </li>
        </ul>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.js"></script>
    <script>
        $(document).ready(function() {
            // Input box for constructing question
            let equationInput = $('#equation-input');

            // Render the equation as the user clicks buttons
            $('.symbol-button').click(function() {
                let symbol = $(this).data('symbol');
                insertAtCursor(equationInput[0], symbol);
                renderKaTeX(equationInput.val(), '#question-preview');
            });

            // Render the equation as the user types
            equationInput.on('input', function() {
                renderKaTeX($(this).val(), '#question-preview');
            });

            // Method to render the KaTeX
            function renderKaTeX(text, elementToRender) {
                try {
                    var renderedEquation = katex.renderToString(text, { throwOnError: false, displayMode: true });
                    $(elementToRender).html(renderedEquation);
                } catch (e) {
                    $(elementToRender).text('Error in rendering: ' + e.message);
                }
            }

            // Render KaTeX for each question's equation in the list of equations
            $('.katex-equation').each(function() {
                let equation = $(this).text();
                renderKaTeX(equation, this);
            });

            // Method so that symbols are inserted at the user's cursor position
            function insertAtCursor(input, textToInsert) {
                let startPos = input.selectionStart;
                let endPos = input.selectionEnd;
                let cursorPos = startPos;
                let textBefore = input.value.substring(0, startPos);
                let textAfter  = input.value.substring(endPos, input.value.length);
                input.value = textBefore + textToInsert + textAfter;
                cursorPos += textToInsert.length;
                input.selectionStart = cursorPos;
                input.selectionEnd = cursorPos;
                input.focus();
            }
        });
    </script>
</body>
</html>
